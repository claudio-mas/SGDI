<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>{% block title %}SGDI{% endblock %}</title>
    <meta name="description" content="{% block meta_description %}Sistema de Gerenciamento Eletrônico de Documentos - Organize, gerencie e controle seus documentos com eficiência{% endblock %}">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    
    <!-- Preconnect to CDNs for better performance -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="preconnect" href="https://code.jquery.com" crossorigin>
    
    <!-- Compiled CSS - Includes Bootstrap 5, Layout, and Components -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}?v=1.0.0">
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/custom.css') }}?v=1.0.0">
    <!-- UI overrides: focus outlines, accessibility helpers -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/ui_overrides.css') }}?v=1.0.0">
    <!-- Animations & Transitions -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/animations.css') }}?v=1.0.0">
    
    {% block extra_css %}{% endblock %}
</head>
<body class="{% if current_user.is_authenticated %}has-sidebar{% endif %}">
    <!-- Navigation Bar -->
    {% if current_user and current_user.is_authenticated %}
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top">
        <div class="container-fluid">
            <!-- Sidebar Toggle Button -->
            <button class="btn btn-link text-white me-2 d-lg-none" type="button" id="sidebarToggleMobile">
                <i class="bi bi-list fs-4"></i>
            </button>
            
            <!-- Brand with Logo -->
            <a class="navbar-brand d-flex align-items-center" href="{{ url_for('documents.list_documents') }}">
                {% if system_logo %}
                    <img src="{{ url_for('admin.uploaded_file', filename=system_logo) }}" 
                         alt="SGDI" height="30" class="d-none d-md-inline me-2">
                {% else %}
                    <img src="{{ url_for('static', filename='assets/images/python.png') }}" 
                         alt="SGDI" height="30" class="d-none d-md-inline me-2">
                {% endif %}
                <span class="d-none d-md-inline">SGDI</span>
            </a>
            
            <!-- Mobile Toggle -->
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" 
                    aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <!-- Search Bar -->
                <div class="navbar-search mx-auto my-2 my-lg-0">
                    <i class="bi bi-search navbar-search-icon"></i>
                    <input type="text" 
                           class="form-control navbar-search-input" 
                           id="navbar-search-input" 
                           placeholder="Buscar documentos..."
                           autocomplete="off">
                    <div id="navbar-search-suggestions" class="list-group" style="display: none;"></div>
                </div>
                
                <!-- Right Navigation -->
                <ul class="navbar-nav ms-auto">
                    <!-- Notifications (placeholder for future) -->
                    <li class="nav-item dropdown d-none d-lg-block">
                        <a class="nav-link" href="#" id="notificationsDropdown" role="button" 
                           data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-bell fs-5"></i>
                            <span class="badge bg-danger rounded-pill position-absolute top-0 start-100 translate-middle d-none">
                                0
                            </span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="notificationsDropdown">
                            <li><h6 class="dropdown-header">Notificações</h6></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-muted text-center" href="#">
                                <small>Nenhuma notificação</small>
                            </a></li>
                        </ul>
                    </li>
                    
                    <!-- User Dropdown -->
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="navbarDropdown" 
                           role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-person-circle fs-5 me-1"></i>
                            <span class="d-none d-md-inline">{{ current_user.nome }}</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                            <li><h6 class="dropdown-header">{{ current_user.email }}</h6></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="{{ url_for('auth.profile') }}">
                                <i class="bi bi-person me-2"></i> Meu Perfil
                            </a></li>
                            <li><a class="dropdown-item" href="{{ url_for('auth.change_password') }}">
                                <i class="bi bi-key me-2"></i> Alterar Senha
                            </a></li>
                            {% if current_user.has_permission('admin') %}
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="{{ url_for('admin.dashboard') }}">
                                <i class="bi bi-gear me-2"></i> Administração
                            </a></li>
                            {% endif %}
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-danger" href="{{ url_for('auth.logout') }}">
                                <i class="bi bi-box-arrow-right me-2"></i> Sair
                            </a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h5 class="mb-0">Menu</h5>
            <button class="btn btn-link text-white d-lg-none" id="sidebarClose">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        
        <nav class="sidebar-nav">
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link {% if request.endpoint == 'documents.list_documents' %}active{% endif %}" 
                       href="{{ url_for('documents.list_documents') }}">
                        <i class="bi bi-house-door me-2"></i> Início
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {% if request.endpoint == 'documents.upload' %}active{% endif %}" 
                       href="{{ url_for('documents.upload') }}">
                        <i class="bi bi-cloud-upload me-2"></i> Upload de Documentos
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {% if request.endpoint and request.endpoint.startswith('search.') %}active{% endif %}" 
                       href="{{ url_for('search.search') }}">
                        <i class="bi bi-search me-2"></i> Buscar
                    </a>
                </li>
                
                <li class="nav-divider"></li>
                <li class="nav-header">Organização</li>
                
                <li class="nav-item">
                    <a class="nav-link {% if request.endpoint == 'categories.list_categories' %}active{% endif %}" 
                       href="{{ url_for('categories.list_categories') }}">
                        <i class="bi bi-tag me-2"></i> Categorias
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {% if request.endpoint and 'folder' in request.endpoint %}active{% endif %}" 
                       href="{{ url_for('categories.list_folders') }}">
                        <i class="bi bi-folder me-2"></i> Pastas
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {% if request.args.get('filter') == 'my' %}active{% endif %}" 
                       href="{{ url_for('documents.list_documents') }}?filter=my">
                        <i class="bi bi-file-earmark-person me-2"></i> Meus Documentos
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {% if request.args.get('filter') == 'recent' %}active{% endif %}" 
                       href="{{ url_for('documents.list_documents') }}?filter=recent">
                        <i class="bi bi-clock-history me-2"></i> Recentes
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {% if request.args.get('filter') == 'favorites' %}active{% endif %}" 
                       href="{{ url_for('documents.list_documents') }}?filter=favorites">
                        <i class="bi bi-star me-2"></i> Favoritos
                    </a>
                </li>
                
                {% if current_user.has_permission('approve') %}
                <li class="nav-divider"></li>
                <li class="nav-header">Workflows</li>
                
                <li class="nav-item">
                    <a class="nav-link {% if request.endpoint == 'workflows.pending_approvals' %}active{% endif %}" 
                       href="{{ url_for('workflows.pending_approvals') }}">
                        <i class="bi bi-clock-history me-2"></i> Aprovações Pendentes
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {% if request.endpoint == 'workflows.list_workflows' %}active{% endif %}" 
                       href="{{ url_for('workflows.list_workflows') }}">
                        <i class="bi bi-diagram-3 me-2"></i> Gerenciar Workflows
                    </a>
                </li>
                {% endif %}
                
                {% if current_user.has_permission('admin') %}
                <li class="nav-divider"></li>
                <li class="nav-header">Administração</li>
                
                <li class="nav-item">
                    <a class="nav-link {% if request.endpoint == 'admin.dashboard' %}active{% endif %}" 
                       href="{{ url_for('admin.dashboard') }}">
                        <i class="bi bi-speedometer2 me-2"></i> Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {% if request.endpoint in ['admin.users', 'admin.list_users'] %}active{% endif %}" 
                       href="{{ url_for('admin.users') }}">
                        <i class="bi bi-people me-2"></i> Usuários
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {% if request.endpoint == 'admin.reports' %}active{% endif %}" 
                       href="{{ url_for('admin.reports') }}">
                        <i class="bi bi-graph-up me-2"></i> Relatórios
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {% if request.endpoint == 'admin.settings' %}active{% endif %}" 
                       href="{{ url_for('admin.settings') }}">
                        <i class="bi bi-gear me-2"></i> Configurações
                    </a>
                </li>
                {% endif %}
            </ul>
        </nav>
    </div>
    
    <!-- Sidebar Overlay (for mobile) -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    
    <!-- Global Loading Overlay -->
    <div class="loading-overlay fade-in" id="globalLoadingOverlay" style="display: none;">
        <div class="loading-overlay-content">
            <div class="spinner-border text-light mb-3" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Carregando...</span>
            </div>
            <p class="text-light loading-message">Carregando...</p>
        </div>
    </div>
    {% endif %}

    <!-- Main Content Wrapper -->
    <div class="{% if current_user.is_authenticated %}main-content{% else %}container-fluid{% endif %}">
        {% if current_user.is_authenticated %}
        <!-- Breadcrumb -->
        {% block breadcrumb %}
        <nav aria-label="breadcrumb" class="breadcrumb-container">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('documents.list_documents') }}"><i class="bi bi-house-door"></i> Início</a></li>
                {% block breadcrumb_items %}{% endblock %}
            </ol>
        </nav>
        {% endblock %}
        {% endif %}
        
        <!-- Flash Messages (a11y: announce changes) -->
            <div id="flash-messages-container" aria-live="polite" aria-atomic="true">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show fade-in-down" role="alert">
                            {% if category == 'success' %}
                                <i class="bi bi-check-circle me-2"></i>
                            {% elif category == 'error' or category == 'danger' %}
                                <i class="bi bi-exclamation-triangle me-2"></i>
                            {% elif category == 'warning' %}
                                <i class="bi bi-exclamation-circle me-2"></i>
                            {% elif category == 'info' %}
                                <i class="bi bi-info-circle me-2"></i>
                            {% endif %}
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
        </div>
        
        <!-- Page Content -->
        <div class="{% if not current_user.is_authenticated %}container mt-5{% endif %}">
            {% block content %}{% endblock %}
        </div>
    </div>
    
    <!-- Footer -->
    {% if current_user.is_authenticated %}
    <footer class="footer mt-auto py-3 bg-light">
        <div class="container-fluid">
            <div class="row">
                <div class="col-md-6 text-center text-md-start">
                    <span class="text-muted">&copy; 2025 SGDI. Todos os direitos reservados.</span>
                </div>
                <div class="col-md-6 text-center text-md-end">
                    <span class="text-muted">Versão 1.0.0</span>
                </div>
            </div>
        </div>
    </footer>
    {% endif %}
    
    <!-- jQuery (loaded first) -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    
    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Main JavaScript -->
    <script src="{{ url_for('static', filename='js/main.js') }}?v=1.0.0"></script>
    <!-- UI helpers: disable submit buttons on send, focus flash messages -->
    <script src="{{ url_for('static', filename='js/ui_helpers.js') }}?v=1.0.0"></script>
    <!-- Animations & Loading States -->
    <script src="{{ url_for('static', filename='js/animations.js') }}?v=1.0.0"></script>
    
    <!-- Sidebar Toggle Script -->
    {% if current_user and current_user.is_authenticated %}
    <script>
    $(document).ready(function() {
        // Sidebar toggle for mobile
        $('#sidebarToggleMobile, #sidebarClose').on('click', function() {
            $('#sidebar').toggleClass('show');
            $('#sidebarOverlay').toggleClass('show');
            $('body').toggleClass('sidebar-open');
        });
        
        // Close sidebar when clicking overlay
        $('#sidebarOverlay').on('click', function() {
            $('#sidebar').removeClass('show');
            $('#sidebarOverlay').removeClass('show');
            $('body').removeClass('sidebar-open');
        });
        
        // Close sidebar on window resize if desktop
        $(window).on('resize', function() {
            if ($(window).width() >= 992) {
                $('#sidebar').removeClass('show');
                $('#sidebarOverlay').removeClass('show');
                $('body').removeClass('sidebar-open');
            }
        });
    });
    </script>
    
    <!-- Navbar Search Autocomplete -->
    <script>
    $(document).ready(function() {
        let searchTimeout;
        const $navbarSearchInput = $('#navbar-search-input');
        const $navbarSuggestions = $('#navbar-search-suggestions');
        
        // Search autocomplete
        $navbarSearchInput.on('input', function() {
            clearTimeout(searchTimeout);
            const query = $(this).val().trim();
            
            if (query.length < 2) {
                $navbarSuggestions.hide().empty();
                return;
            }
            
            searchTimeout = setTimeout(function() {
                $.ajax({
                    url: '{{ url_for("search.suggestions") }}',
                    data: { q: query, limit: 8 },
                    success: function(data) {
                        $navbarSuggestions.empty();
                        
                        let hasResults = false;
                        
                        // Add document suggestions
                        if (data.documents && data.documents.length > 0) {
                            $navbarSuggestions.append(
                                '<div class="list-group-item list-group-item-secondary py-1 px-3"><small><strong>Documentos</strong></small></div>'
                            );
                            data.documents.slice(0, 3).forEach(function(doc) {
                                $navbarSuggestions.append(
                                    $('<a>')
                                        .addClass('list-group-item list-group-item-action py-2 px-3')
                                        .attr('href', '{{ url_for("search.search") }}?q=' + encodeURIComponent(doc))
                                        .html('<i class="bi bi-file-earmark me-2"></i>' + doc)
                                );
                            });
                            hasResults = true;
                        }
                        
                        // Add tag suggestions
                        if (data.tags && data.tags.length > 0) {
                            $navbarSuggestions.append(
                                '<div class="list-group-item list-group-item-secondary py-1 px-3"><small><strong>Tags</strong></small></div>'
                            );
                            data.tags.slice(0, 3).forEach(function(tag) {
                                $navbarSuggestions.append(
                                    $('<a>')
                                        .addClass('list-group-item list-group-item-action py-2 px-3')
                                        .attr('href', '{{ url_for("search.search") }}?q=' + encodeURIComponent(tag))
                                        .html('<i class="bi bi-tag me-2"></i>' + tag)
                                );
                            });
                            hasResults = true;
                        }
                        
                        // Add category suggestions
                        if (data.categories && data.categories.length > 0) {
                            $navbarSuggestions.append(
                                '<div class="list-group-item list-group-item-secondary py-1 px-3"><small><strong>Categorias</strong></small></div>'
                            );
                            data.categories.slice(0, 2).forEach(function(cat) {
                                $navbarSuggestions.append(
                                    $('<a>')
                                        .addClass('list-group-item list-group-item-action py-2 px-3')
                                        .attr('href', '{{ url_for("search.search") }}?q=' + encodeURIComponent(cat))
                                        .html('<i class="bi bi-folder me-2"></i>' + cat)
                                );
                            });
                            hasResults = true;
                        }
                        
                        // Add "View all results" link
                        if (hasResults) {
                            $navbarSuggestions.append(
                                $('<a>')
                                    .addClass('list-group-item list-group-item-action text-center py-2 text-primary')
                                    .attr('href', '{{ url_for("search.search") }}?q=' + encodeURIComponent(query))
                                    .html('<i class="bi bi-search me-2"></i>Ver todos os resultados para "' + query + '"')
                            );
                            $navbarSuggestions.show();
                        } else {
                            $navbarSuggestions.hide();
                        }
                    },
                    error: function() {
                        $navbarSuggestions.hide().empty();
                    }
                });
            }, 300);
        });
        
        // Handle Enter key
        $navbarSearchInput.on('keypress', function(e) {
            if (e.which === 13) {
                const query = $(this).val().trim();
                if (query) {
                    window.location.href = '{{ url_for("search.search") }}?q=' + encodeURIComponent(query);
                }
            }
        });
        
        // Hide suggestions when clicking outside
        $(document).on('click', function(e) {
            if (!$(e.target).closest('.navbar-search').length) {
                $navbarSuggestions.hide();
            }
        });
        
        // Show suggestions when focusing on input if there's content
        $navbarSearchInput.on('focus', function() {
            if ($(this).val().trim().length >= 2 && $navbarSuggestions.children().length > 0) {
                $navbarSuggestions.show();
            }
        });
    });
    </script>
    {% endif %}
    
    {% block extra_js %}{% endblock %}
</body>
</html>
