{% extends "base.html" %}

{% block title %}Buscar Documentos - SGDI{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Sidebar -->
        <nav class="col-md-3 col-lg-2 d-md-block bg-light sidebar">
            <div class="position-sticky pt-3">
                <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                    <span>Filtros Rápidos</span>
                </h6>
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('search.quick_filter', filter_type='my_documents') }}">
                            <i class="bi bi-file-earmark"></i> Meus Documentos
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('search.quick_filter', filter_type='recent') }}">
                            <i class="bi bi-clock-history"></i> Recentes
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('search.quick_filter', filter_type='favorites') }}">
                            <i class="bi bi-star"></i> Favoritos
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('search.quick_filter', filter_type='pending_approval') }}">
                            <i class="bi bi-hourglass-split"></i> Pendente de Aprovação
                        </a>
                    </li>
                </ul>
                
                <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                    <span>Busca Avançada</span>
                </h6>
                <ul class="nav flex-column mb-2">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('search.advanced_search') }}">
                            <i class="bi bi-funnel"></i> Busca Avançada
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('search.fulltext_search') }}">
                            <i class="bi bi-file-text"></i> Busca em Conteúdo
                        </a>
                    </li>
                </ul>
            </div>
        </nav>

        <!-- Main content -->
        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h1 class="h2">Buscar Documentos</h1>
            </div>

            <!-- Search Form -->
            <div class="row mb-4">
                <div class="col-lg-8 mx-auto">
                    <form method="GET" action="{{ url_for('search.search') }}" class="search-form">
                        <div class="input-group input-group-lg">
                            <input type="text" 
                                   name="q" 
                                   class="form-control" 
                                   placeholder="Buscar por nome, descrição ou tags..." 
                                   value="{{ request.args.get('q', '') }}"
                                   id="search-input"
                                   autocomplete="off">
                            <button class="btn btn-primary" type="submit">
                                <i class="bi bi-search"></i> Buscar
                            </button>
                        </div>
                        <!-- Autocomplete suggestions dropdown -->
                        <div id="search-suggestions" class="list-group position-absolute w-100 shadow-sm" style="display: none; z-index: 1000;"></div>
                    </form>
                    
                    <div class="mt-3 text-center">
                        <a href="{{ url_for('search.advanced_search') }}" class="text-decoration-none">
                            <i class="bi bi-funnel"></i> Busca Avançada
                        </a>
                        <span class="mx-2">|</span>
                        <a href="{{ url_for('search.fulltext_search') }}" class="text-decoration-none">
                            <i class="bi bi-file-text"></i> Buscar em Conteúdo
                        </a>
                    </div>
                </div>
            </div>

            <!-- Statistics -->
            {% if stats %}
            <div class="row g-3 mb-4">
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title">{{ stats.owned_documents }}</h5>
                            <p class="card-text text-muted">Meus Documentos</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title">{{ stats.shared_documents }}</h5>
                            <p class="card-text text-muted">Compartilhados Comigo</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title">{{ stats.recent_documents }}</h5>
                            <p class="card-text text-muted">Recentes (7 dias)</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title">{{ stats.total_accessible }}</h5>
                            <p class="card-text text-muted">Total Acessível</p>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Search Tips -->
            <div class="row">
                <div class="col-lg-8 mx-auto">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-lightbulb"></i> Dicas de Busca</h5>
                        </div>
                        <div class="card-body">
                            <ul class="mb-0">
                                <li>Use a <strong>busca simples</strong> para encontrar documentos por nome, descrição ou tags</li>
                                <li>Use a <strong>busca avançada</strong> para filtrar por categoria, tipo de arquivo, data, tamanho e mais</li>
                                <li>Use a <strong>busca em conteúdo</strong> para pesquisar dentro do texto de documentos PDF</li>
                                <li>Os <strong>filtros rápidos</strong> na barra lateral permitem acesso rápido aos seus documentos</li>
                                <li>A busca considera apenas documentos que você possui ou que foram compartilhados com você</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<style>
.sidebar {
    position: fixed;
    top: 56px;
    bottom: 0;
    left: 0;
    z-index: 100;
    padding: 0;
    box-shadow: inset -1px 0 0 rgba(0, 0, 0, .1);
    overflow-y: auto;
}

.sidebar .nav-link {
    font-weight: 500;
    color: #333;
    padding: 0.75rem 1rem;
}

.sidebar .nav-link:hover {
    background-color: #e9ecef;
}

.sidebar .nav-link i {
    margin-right: 0.5rem;
}

.search-form {
    position: relative;
}

#search-suggestions {
    max-height: 400px;
    overflow-y: auto;
    margin-top: 2px;
}

#search-suggestions .list-group-item {
    cursor: pointer;
}

#search-suggestions .list-group-item:hover {
    background-color: #f8f9fa;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Search autocomplete
    let searchTimeout;
    const $searchInput = $('#search-input');
    const $suggestions = $('#search-suggestions');
    
    $searchInput.on('input', function() {
        clearTimeout(searchTimeout);
        const query = $(this).val().trim();
        
        if (query.length < 2) {
            $suggestions.hide().empty();
            return;
        }
        
        searchTimeout = setTimeout(function() {
            $.ajax({
                url: '{{ url_for("search.suggestions") }}',
                data: { q: query, limit: 10 },
                success: function(data) {
                    $suggestions.empty();
                    
                    let hasResults = false;
                    
                    // Add document suggestions
                    if (data.documents && data.documents.length > 0) {
                        $suggestions.append('<div class="list-group-item list-group-item-secondary"><strong>Documentos</strong></div>');
                        data.documents.forEach(function(doc) {
                            $suggestions.append(
                                $('<a>')
                                    .addClass('list-group-item list-group-item-action')
                                    .attr('href', '{{ url_for("search.search") }}?q=' + encodeURIComponent(doc))
                                    .html('<i class="bi bi-file-earmark"></i> ' + doc)
                            );
                        });
                        hasResults = true;
                    }
                    
                    // Add tag suggestions
                    if (data.tags && data.tags.length > 0) {
                        $suggestions.append('<div class="list-group-item list-group-item-secondary"><strong>Tags</strong></div>');
                        data.tags.forEach(function(tag) {
                            $suggestions.append(
                                $('<a>')
                                    .addClass('list-group-item list-group-item-action')
                                    .attr('href', '{{ url_for("search.search") }}?q=' + encodeURIComponent(tag))
                                    .html('<i class="bi bi-tag"></i> ' + tag)
                            );
                        });
                        hasResults = true;
                    }
                    
                    // Add category suggestions
                    if (data.categories && data.categories.length > 0) {
                        $suggestions.append('<div class="list-group-item list-group-item-secondary"><strong>Categorias</strong></div>');
                        data.categories.forEach(function(cat) {
                            $suggestions.append(
                                $('<a>')
                                    .addClass('list-group-item list-group-item-action')
                                    .attr('href', '{{ url_for("search.search") }}?q=' + encodeURIComponent(cat))
                                    .html('<i class="bi bi-folder"></i> ' + cat)
                            );
                        });
                        hasResults = true;
                    }
                    
                    if (hasResults) {
                        $suggestions.show();
                    } else {
                        $suggestions.hide();
                    }
                },
                error: function() {
                    $suggestions.hide().empty();
                }
            });
        }, 300);
    });
    
    // Hide suggestions when clicking outside
    $(document).on('click', function(e) {
        if (!$(e.target).closest('.search-form').length) {
            $suggestions.hide();
        }
    });
    
    // Show suggestions when focusing on input if there's content
    $searchInput.on('focus', function() {
        if ($(this).val().trim().length >= 2 && $suggestions.children().length > 0) {
            $suggestions.show();
        }
    });
});
</script>
{% endblock %}
